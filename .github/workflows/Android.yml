name: Android CI (NDK 26)

on:
  push:
    branches: [ "1" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest  # Apple Silicon 运行器
    env:
      NDK_VERSION: "26.2.11394342"  # NDK 26.2 最新稳定版
      WORKSPACE_PATH: ${{ github.workspace }}/Test-ryu
      TARGET_ARCH: "aarch64-linux-android21"

    steps:
      # ----------------------------------------
      # 1. 检出代码
      # ----------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: mipad/Test-ryu
          ref: "1"
          path: Test-ryu

      # ----------------------------------------
      # 2. 配置 Java 环境
      # ----------------------------------------
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # ----------------------------------------
      # 3. 安装 Android NDK 26
      # ----------------------------------------
      - name: Install Android NDK
        run: |
          # 安装指定版本 NDK
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "ndk;${{ env.NDK_VERSION }}"
          
          # 接受所有 Android 许可证
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses

          # 验证 NDK 安装路径
          echo "NDK 安装路径: $ANDROID_HOME/ndk/${{ env.NDK_VERSION }}"
          ls -l $ANDROID_HOME/ndk/${{ env.NDK_VERSION }}

      # ----------------------------------------
      # 4. 配置 NDK 路径
      # ----------------------------------------
      - name: Configure NDK Path
        run: |
          # 定义 NDK 路径变量
          NDK_DIR="$ANDROID_HOME/ndk/${{ env.NDK_VERSION }}"
          echo "ndk.dir=$NDK_DIR" >> ${{ env.WORKSPACE_PATH }}/src/RyujinxAndroid/local.properties

          # 动态探测 NDK 工具链路径（兼容不同平台）
          NDK_TOOLCHAIN=$(find "$NDK_DIR/toolchains/llvm/prebuilt" -maxdepth 1 -type d -name "darwin*" | head -n 1)
          if [ -z "$NDK_TOOLCHAIN" ]; then
            echo "::error::NDK 工具链路径未找到，请检查 NDK 安装"
            exit 1
          fi
          echo "NDK_TOOLCHAIN=$NDK_TOOLCHAIN" >> $GITHUB_ENV

          # 验证关键路径
          echo "=== NDK 工具链验证 ==="
          ls -l "$NDK_TOOLCHAIN/bin/clang"
          echo "=== Sysroot 库验证 ==="
          ls -l "$NDK_TOOLCHAIN/sysroot/usr/lib/${{ env.TARGET_ARCH }}/liblog.so"

      # ----------------------------------------
      # 5. 配置构建环境
      # ----------------------------------------
      - name: Setup Build Environment
        run: |
          # 将工具链添加到 PATH
          echo "${{ env.NDK_TOOLCHAIN }}/bin" >> $GITHUB_PATH
          
          # 设置编译器参数
          echo "CC=${{ env.NDK_TOOLCHAIN }}/bin/clang" >> $GITHUB_ENV
          echo "CXX=${{ env.NDK_TOOLCHAIN }}/bin/clang++" >> $GITHUB_ENV
          echo "LDFLAGS=-L${{ env.NDK_TOOLCHAIN }}/sysroot/usr/lib/${{ env.TARGET_ARCH }}" >> $GITHUB_ENV

      # ----------------------------------------
      # 6. 构建项目
      # ----------------------------------------
      - name: Build Project
        run: |
          cd ${{ env.WORKSPACE_PATH }}/src/RyujinxAndroid
          
          # 清理并构建
          ./gradlew clean assembleRelease \
              -Pandroid.ndkPath="${{ env.NDK_TOOLCHAIN }}" \
              -Pandroid.extraLdFlags="-Wl,--sysroot=${{ env.NDK_TOOLCHAIN }}/sysroot" \
              --stacktrace --info

          # 验证产物
          echo "=== 生成的 .so 文件 ==="
          find . -name "*.so"

      # ----------------------------------------
      # 7. 上传产物（含缓存优化）
      # ----------------------------------------
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: ryujinx-ndk26-build-${{ github.run_number }}
          path: |
            ${{ env.WORKSPACE_PATH }}/src/RyujinxAndroid/app/build/outputs/apk/release/*.apk
            ${{ env.WORKSPACE_PATH }}/src/RyujinxAndroid/**/*.so
          retention-days: 7

      # ----------------------------------------
      # [可选] 缓存 NDK 加速后续构建
      # ----------------------------------------
      - name: Cache NDK
        uses: actions/cache@v3
        with:
          path: $ANDROID_HOME/ndk/${{ env.NDK_VERSION }}
          key: ndk-${{ env.NDK_VERSION }}
